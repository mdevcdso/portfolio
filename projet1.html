<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assoweb</title>
    <link href="./dist/output.css" rel="stylesheet">
    <link href="./styles.css" rel="stylesheet">
    <link href="./script.js" rel="stylesheet">
</head>
<body>
    <header class="header">
        <nav class="navbar border-b border-black">
            <div class="navbar-logo">
                <img class="photo_profil" src="/img/pp.jpg" alt="photo-profil">
                <a href="index.html">MC.</a>
            </div>
            <div class="navbar-menu">
                <ol>
                    <li>
                        <a href="presentation.html">
                            Présentation de la société
                        </a>
                    </li>
                    <li>
                        <a href="projets.html">
                            Projets
                        </a>
                    </li>
                    <li>
                        <a href="veille.html">
                            Veille informatique
                        </a>
                    </li>
                    <li>
                        <a href="a-propos.html">
                            A propos
                        </a>
                    </li>
                </ol>
            </div>
        </nav>
    </header>

    <section class="profil">
        <div class="flex flex-col justify-center items-center">
            <div class="flex justify-center items-center space-x-8"> 
                <h1 class="titre">
                    <span class="font-bold" style="color: rgb(246, 0, 0);">|</span>  Gestionnaire de spams
                </h1>
            </div>

            <div id="project-description-1" class="project-description">
                <h3 style="font-size: 25px;">Présentation</h3>
                <div style="display: block;">
                    <p>
                        <strong>Le projet Mail Cleaner</strong> représente une solution axée sur la gestion d'e-mails indésirables de la boîte de réception du site associatif Assoweb. 
                        Développé principalement avec le langage PHP, ce système vise à optimiser la sécurité et la propreté de la boîte mail du support en identifiant et en triant les e-mails considérés comme spam, afin d'identifier les faux comptes des vrais.
                    </p>
                
                    <br>

                    <h4 style="font-size: 20px;"><strong>Fonctionnalités :</strong></h4>
                    <ul>
                        <li><strong>Filtrage de Spam :</strong> Le cœur du projet réside dans son mécanisme sophistiqué de filtrage des e-mails. Grâce à des algorithmes avancés, le Mail Cleaner analyse le contenu des messages pour identifier les caractéristiques typiques du spam.</li>
                
                        <li><strong>Base de Données (BDD) :</strong> L'utilisation du langage SQL permet une intégration fluide avec la base de données. Les informations pertinentes sur les e-mails identifiés comme spam sont stockées de manière organisée, offrant une traçabilité pour des actions ultérieures.</li>
                
                        <li><strong>Identification des Adresses Malveillantes :</strong> Chaque e-mail considéré comme du spam est associé à une adresse mail d'origine. Le système détermine la raison pour laquelle cette adresse est considérée comme malveillante, fournissant ainsi des informations détaillées sur les motifs du filtrage.</li>
                
                        <li><strong>Nettoyage Automatique :</strong> Une fois que les e-mails indésirables sont identifiés et les informations correspondantes sont stockées dans la base de données, le Mail Cleaner peut automatiquement supprimer ces messages, assurant ainsi une boîte de réception propre et sécurisée.</li>
                
                        <li><strong>Interface Utilisateur Intuitive :</strong> Le projet intègre une interface utilisateur conviviale, permettant aux utilisateurs de visualiser les statistiques de filtrage, d'ajuster les paramètres et de prendre des décisions manuelles si nécessaire.</li>
                    </ul>
                
                    <p>
                        Le projet Mail Cleaner s'impose comme une solution essentielle pour les utilisateurs d'Assoweb, cherchant à maintenir la sécurité de leur boîte de réception en éliminant de manière proactive les e-mails indésirables. 
                        En combinant une approche technologique avancée avec une interface utilisateur accessible, Mail Cleaner offre une solution complète au support du site Assoweb afin d'effectuer un nettoyage efficace et automatisé des boîtes mail.
                    </p>

                    <br>

                    <img src="/img/bdd.PNG" alt="bdd" style="height: 35rem;">
                </div>

                <div style="margin-top: 4rem;"></div>

                <h3 style="font-size: 25px;">Les Technologies utilisées</h3>
                <div>
                    <span>PHP</span>
                    <span>MySql</span>
                </div>

                <div style="margin-top: 3rem;"></div>

                <h3 style="font-size: 25px;">Code</h3>
                <div class="card">
                    <div class="header-card">
                        <div class="top">
                        <div class="circle">
                            <span class="red circle2"></span>
                        </div>
                        <div class="circle">
                            <span class="yellow circle2"></span>
                        </div>
                        <div class="circle">
                            <span class="green circle2"></span>
                        </div>
                        <div class="title">
                            <p id="title2">MailManager.php</p>
                        </div>
                        </div>
                    </div>
                    <div class="code-container">
                        <textarea readonly="" name="code" id="code" class="area">
                            <?php



class MailManager 

{

    private $host; //variable de class

    private $dbname; //variable de class

    private $asso_dbname;

    private $user; //variable de class

    private $pass; //variable de class

    private $asso_pass;

    private $token;

    static private $limit = 500; // limite de 500 données affichées



    private $collectedEmailsCount = 0; // nouvelle variable de classe



    function __construct() 

    {

        $envFile = '.env';



        if (file_exists($envFile)) { //appel du fichier .env

            $env = parse_ini_file($envFile); //parse du fichier .env en une nouvelle variable $env

        }

                    

        $this->host = isset($env['DB_HOST']) ? $env['DB_HOST'] : "localhost"; //instancier / associer la variable à host

        $this->dbname = isset($env['DB_DATABASE']) ? $env['DB_DATABASE'] : "database";

        $this->asso_dbname = isset($env['DB_ASSO_DATABASE']) ? $env['DB_ASSO_DATABASE'] : "database";

        $this->user = isset($env['DB_USERNAME']) ? $env['DB_USERNAME'] : "root";

        $this->pass = isset($env['DB_PASSWORD']) ? $env['DB_PASSWORD'] : "";

        $this->asso_pass = isset($env['DB_ASSO_PASSWORD']) ? $env['DB_ASSO_PASSWORD'] : "";

        $this->token = isset($env['SENDGRID_TOKEN']) ? $env['SENDGRID_TOKEN'] : "";



        error_reporting(E_ALL);

        ini_set("display_errors", 1);

    }



    function getCollectedEmailsCount() 

    {

        return $this->collectedEmailsCount;

    }



    function getAndPersistEmails($resource_name, $page = 0) 

    {

        $ch = curl_init();



        $this->sql_connect();



        $last_sync_date = $this->get_last_sync_date();

        $start_time = strtotime($last_sync_date);  //timestamp



        $query_params = http_build_query([

            'limit'=>self::$limit,

            'offset'=>self::$limit * $page, //commencer à partir d'un résultat

            'start_time'=>$start_time,

        ]);

    

        curl_setopt($ch, CURLOPT_URL, 'https://api.sendgrid.com/v3/suppression/' . $resource_name . "?" . $query_params);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'GET');

    

        

    

        $headers = array();

        $headers[] = 'Authorization: Bearer ' . $this->token;

        $headers[] = 'Content-Type: application/json';

        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    

        $result = curl_exec($ch);

        if (curl_errno($ch)) {

            echo 'Error:' . curl_error($ch);

        }

    

        $parsed_email = json_decode($result); //utilisé dans la boucle foreach, conversion de nos données

    

        // if (isset($parsed_email->errors) && is_array($parsed_email->errors)) {

        //     foreach ($parsed_email->errors as $error) {

        //         echo "API Error: " . $error->message . "\n";

        //     }

        // } else {

            foreach ($parsed_email as $value) {

    

                $mail = $value->email;

                

                if (!$this->exists($mail)) {

                    $created_at = date("Y-m-d H:i:s");

                    $created_at_sendgrid = date("Y-m-d H:i:s", $value->created); //fonction date

                    $reason = null;

        

                    if (isset($value->reason)) { // vérifie si la variable existe et != null

                        $reason = $value->reason;

                        $reason = str_replace('"', '\"', $reason);

                    }

            

                    $query = "INSERT INTO mails (mail, created_at, created_at_sendgrid, type, reason)

                    VALUES ( \"" . $mail . "\" , \"" . $created_at . "\" , \"" . $created_at_sendgrid . "\" , \"" . $resource_name . "\",\"" . $reason . "\")";

                    mysql_query($query) or die('erreur de sql getAndPersistEmails' . '<br>' . mysql_error());



                    $this->collectedEmailsCount++; // incrémenter le compteur



                    // Vérifier si le nombre limite est atteint

                    if ($this->collectedEmailsCount >= 1000) {

                        break;

                    }

                }

            }

        //}

    

        curl_close($ch);

        mysql_close();



        if (!empty($parsed_email)) {

            $this->getAndPersistEmails($resource_name, $page+1);

        }

    }



    function sync_new_abonnes_and_members()

    {

        $this->sql_connect();



        $query = mysql_query("SELECT s.site_id AS site_id, site_adresse 

        FROM `" . $this->asso_dbname . "`.site s");



        while ($site = mysql_fetch_assoc($query)) {

            $this->sync_abonne_site($site['site_adresse']);

            $this->sync_member_site($site['site_adresse']);

            $this->sync_mails_contact($site['site_adresse']);

        }



        mysql_close();

    }



    function delete_adress()

    {

        $this->sql_connect();



        $query = mysql_query("SELECT s.adresse AS site_adresse 

        FROM `". $this->dbname ."`.sites s

        WHERE s.adresse = 'loic-lefebvre'") or die('erreur de sql delete_adress' . ' <br> ' . mysql_error());



        while ($row = mysql_fetch_assoc($query)) {

            $this->delete_abonne_mail($row['site_adresse']);

        };



        mysql_close();

    }



    function sync_new_users() //pour récupérer la liste des mails

    {

        $this->sql_connect();



        $query = "INSERT INTO users (`nom`, `prenom`, `mail_id`, `site_id`, `type`)

        SELECT u.user_nom, u.user_prenom, m.id as mail_id, s.id as site_id, 'COMPTE ASSOWEB' AS type

        

        FROM `" . $this->asso_dbname . "`.user u 

        

        INNER JOIN `". $this->dbname ."`.mails m 

        ON u.user_login = m.mail 

        

        INNER JOIN `" . $this->asso_dbname . "`.site_user su 

        ON u.user_id = su.id_user 

        

        INNER JOIN `". $this->dbname ."`.sites s 

        ON su.id_site = s.original_id 

        

        WHERE m.created_at > (SELECT COALESCE(MIN(last_sync_date), '1970-01-01') FROM settings)";



        mysql_query($query) or die('erreur de sql sync_new_users' . ' <br> ' . mysql_error());

        

        mysql_close();



        return;

    }



    function sync_new_sites()

    {

        $this->sql_connect();



        $query = "INSERT INTO `". $this->dbname ."`.sites (original_id, adresse, titre)

        SELECT DISTINCT s.site_id, s.site_adresse, s.site_titre

        

        FROM `" . $this->asso_dbname . "`.site s

        

        INNER JOIN `" . $this->asso_dbname . "`.site_user su

        ON su.id_site = s.site_id

        

        INNER JOIN `" . $this->asso_dbname . "`.user u

        ON su.id_user = u.user_id

        

        INNER JOIN `". $this->dbname ."`.mails m

        ON u.user_login = m.mail

        

        WHERE s.site_id NOT IN (SELECT original_id FROM `". $this->dbname ."`.sites)

        AND m.created_at > (SELECT COALESCE(MIN(last_sync_date), '1970-01-01') FROM `". $this->dbname ."`.settings)";



        mysql_query($query) or die('erreur de sql sync_new_sites' . ' <br> ' . mysql_error());

        

        mysql_close();



        return;

    }



    function set_last_sync_date($last_sync_date = null) 

    {

        $this->sql_connect();



        if ($last_sync_date == null) {

            $last_sync_date = date("Y-m-d H:i:s");

        }

        if (!$this->has_last_sync_date()) {

            $query = "INSERT INTO settings (last_sync_date) VALUES ('" . $last_sync_date . "')";

            mysql_query($query) or die('erreur de sql set_last_sync_date' . '<br>' . mysql_error());

        } else {

            mysql_query("UPDATE settings SET last_sync_date = '" . $last_sync_date . "'") or die('erreur de sql update set_last_sync_date' . '<br>' . mysql_error());

        }

        mysql_close();

    }



    private function sql_connect() 

    {

        mysql_connect($this->host, $this->user, $this->pass, false, MYSQL_CLIENT_COMPRESS);

        mysql_select_db($this->dbname);

    }



    private function exists($mail) 

    {

        $query = mysql_query("SELECT mail FROM mails WHERE mail = '" . $mail . "'") or die('erreur de sql exists' . '<br>' . mysql_error()); 

        return !empty(mysql_fetch_row($query));

    }



    private function get_mailId($mail) {

        $query = mysql_query("SELECT * FROM mails WHERE mail = '" . $mail . "'") or die('erreur de sql get_mailId' . '<br>' . mysql_error());

        if (mysql_num_rows($query) > 0) {

            $row = mysql_fetch_row($query);

            return $row[0];

        } else {

            return false;

        }

    }



    private function get_last_sync_date() 

    {

        $query = mysql_query("SELECT last_sync_date FROM settings") or die('erreur de sql get_last_sync_date' . '<br>' . mysql_error());

        $query_result = mysql_fetch_row($query);

        return isset($query_result[0]) ? $query_result[0] : null;

    }



    private function has_last_sync_date()

    {

        return $this->get_last_sync_date() != null;

    }



    private function sync_member_site($site)

    {

        $this->sql_connect();



        $query = mysql_query("

          SELECT m.id AS mail_id, membre.nom_membre AS nom, membre.prenom_membre AS prenom

          FROM `". $this->dbname ."`.mails m

          INNER JOIN `asso_" . $site . "`.membre membre

          ON m.mail = membre.email_membre;") or die('erreur de sql sync_member_site' . '<br>' . mysql_error());



        if (mysql_num_rows($query) > 0) {



            $site_id = $this->get_siteId($site);



            if (!$site_id) {

                $this->createSite($site);

                $site_id = $this->get_siteId($site); 

            }



            while ($membre = mysql_fetch_assoc($query)) {

                $this->create_user($membre['mail_id'], $site_id, 'MEMBRE', $membre['nom'], $membre['prenom']);

            }

        }



        mysql_close();

    }



    private function sync_abonne_site($site) 

    {

        $this->sql_connect();



        $query = mysql_query("SELECT id

        FROM `". $this->dbname ."`.mails

        WHERE mail IN (

          SELECT abonne_mail

          FROM `asso_" . $site . "`.abonne

        )") or die('erreur de sql sync_abonne_site' . '<br>' . mysql_error());



        if (mysql_num_rows($query) > 0) {



            $site_id = $this->get_siteId($site);



            if (!$site_id) {

                $this->createSite($site);

                $site_id = $this->get_siteId($site); 

            }



            while ($membre = mysql_fetch_assoc($query)) {

                $this->create_user($membre['id'], $site_id, 'ABONNE NEWSLETTERS');

            }

        }



        mysql_close();

    }



    private function createSite($site) 

    {

        $query = "INSERT INTO `". $this->dbname ."`.sites (original_id, adresse, titre) 

        SELECT s.site_id, s.site_adresse, s.site_titre FROM `" . $this->asso_dbname . "`.site s

        WHERE s.site_adresse = '" . $site . "'"; 



        if (mysql_query($query)) {

            return true;

        } else {

            return false;

        }

    }



    private function get_siteId($site)

    {

        $query = "SELECT id FROM `". $this->dbname ."`.sites WHERE adresse = '" . $site . "'";

        $query_result = mysql_query($query) or die('erreur de sql get_siteId' . '<br>' . mysql_error());



        if (mysql_num_rows($query_result) > 0) {

            $row = mysql_fetch_row($query_result);

            return $row[0];

        } else {

            return false;

        }

    }



    private function create_user($mail_id, $site_id, $type, $nom = null, $prenom = null) 

    {

        $mail_exist = mysql_query("SELECT * FROM `". $this->dbname ."`.users u WHERE mail_id = '" . $mail_id . "' AND site_id = '" . $site_id . "'") or die('erreur de sql create_user' . '<br>' . mysql_error());



        if(mysql_num_rows($mail_exist) == 0) {

            $query_nom = $nom ? "'" . $nom . "'" : 'NULL';

            $query_prenom = $prenom ? "'" . $prenom . "'" : 'NULL';



            $query = "INSERT INTO `". $this->dbname ."`.users (mail_id, site_id, type, nom, prenom) VALUES ('" . $mail_id . "', '" . $site_id . "', '" . $type . "', " . $query_nom . ", " . $query_prenom . ")";



            if (mysql_query($query)) {

                return true;

            } else {

                return false;

            }

        } else {

            return false;

        }

    }



    private function sync_mails_contact($site_adresse)

    {

        $this->sql_connect();



        $emails = $this->get_mails_contact($site_adresse);

        $this->sync_contact_error($emails, $site_adresse);

        $this->persist_mail_contact($site_adresse, $emails);



        mysql_close();

    }



    private function persist_mail_contact($site_adresse, $emails)
    {
        $query = mysql_query("SELECT id

        FROM `". $this->dbname ."`.sites

        WHERE adresse = '" . $site_adresse . "'") or die('ERREUR de sql' . '<br>' . mysql_error());

        while ($row = mysql_fetch_array($query)) {

            foreach ($emails as $email) {

                mysql_query("INSERT INTO `". $this->dbname ."`.contacts (site_id, mail) 

                VALUES ('" . $row['id'] . "', '" . $email . "')") or die('ERREUR de sql persist_mail_contact' . '<br>' . mysql_error());

            }
        }
    }

    private function get_mails_contact($site_adresse)
    {
        $query = mysql_query("SELECT site.site_email_contact

        FROM `asso_" . $site_adresse . "`.site site") or die('erreur de sql get_mails_contact' . '<br>' . mysql_error());

        $emails = [];

        while ($row = mysql_fetch_array($query)) {

            $emails = array_merge(explode(',', $row['site_email_contact']), $emails);

        }
        return $emails;
    }

    private function sync_contact_error($emails, $site_adresse) 
    {
        foreach($emails as $email_address) {

            $email_id = $this->get_mailId($email_address);

            if ($email_id) {

                $site_id = $this->get_siteId($site_adresse);

                if (!$site_id) {
                    $this->createSite($site_adresse);
                    $site_id = $this->get_siteId($site_adresse); 
                }

                $this->create_user($email_id, $site_id, 'MAIL CONTACT');
            }
        }
    }

    private function delete_abonne_mail($site_adresse)
    {
        $query = mysql_query("DELETE FROM `asso_" . $site_adresse . "`.abonne
        WHERE abonne.abonne_mail IN (SELECT m.mail FROM `". $this->dbname ."`.mails m)") or die('ERREUR de sql delete_abonne_mail' . '<br>' . mysql_error());

        if ($query) {
            return true;
        } else {
            return false;
        }
    }
}
?>
                        </textarea>
                    </div>
                </div>

                <div style="margin-top: 50px;"></div>

                <div class="card">
                    <div class="header-card">
                        <div class="top">
                        <div class="circle">
                            <span class="red circle2"></span>
                        </div>
                        <div class="circle">
                            <span class="yellow circle2"></span>
                        </div>
                        <div class="circle">
                            <span class="green circle2"></span>
                        </div>
                        <div class="title">
                            <p id="title2">get-mail.php</p>
                        </div>
                        </div>
                    </div>
                    <div class="code-container">
                        <textarea readonly="" name="code" id="code" class="area">
                            <?php
    
                            require('MailManager.php'); //charger le fichier 
                            $last_sync_date = date('Y-m-d H:i:s');
                            $mail_manager = new MailManager(); //new instance de l'objet MailManager
    
                            $mail_manager->getAndPersistEmails('spam_reports'); //appel la fonction getAndPersistEmails de spam_reports
                            $mail_manager->getAndPersistEmails('blocks'); //appel la fonction getAndPersistEmails de blocks
                            $mail_manager->getAndPersistEmails('invalid_emails'); //appel la fonction getAndPersistEmails de invalid_emails
                            $mail_manager->getAndPersistEmails('bounces'); //appel la fonction getAndPersistEmails de bounces
    
                            $mail_manager->sync_new_sites();
                            $mail_manager->sync_new_users();
                            $mail_manager->sync_new_abonnes_and_members();
    
                            $mail_manager->set_last_sync_date($last_sync_date);
                        </textarea>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="flex justify-around items-center">
            <div>
                <div class="mb-1">
                    <h1 class="text-center text-white text-lg font-bold">
                        Réseaux sociaux
                    </h1>
                </div>
                <div>
                    <ul class="social-icon">
                        <li class="social-icon__item">
                            <a class="social-icon__link" href="#">
                                <ion-icon name="logo-linkedin"></ion-icon>
                            </a>
                        </li>
                        <li class="social-icon__item">
                            <a class="social-icon__link" href="#">
                                <ion-icon name="logo-github"></ion-icon>
                            </a>
                        </li>
                        <li class="social-icon__item">
                            <a class="social-icon__link" href="#">
                                <ion-icon name="logo-discord"></ion-icon>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="divider"></div>

            <div class="flex flex-col space-y-2">
                <div>
                    <h1 class="text-center text-white text-lg font-bold">
                        Menu
                    </h1>
                </div>
                <div>
                    <ul class="menu">
                        <li class="menu__item"><a class="menu__link" href="index.html">Accueil</a></li>
                        <li class="menu__item"><a class="menu__link" href="presentation.html">Présentation de la société</a></li>
                        <li class="menu__item"><a class="menu__link" href="projets.html">Projets</a></li>
                        <li class="menu__item"><a class="menu__link" href="veille.html">Veille informatique</a></li>
                        <li class="menu__item"><a class="menu__link" href="#">CV</a></li>
                    </ul>
                </div>
            </div>

            <div class="divider"></div>

            <div class="relative flex flex-wrap justify-center items-center text-white sfthin" style="font-size: larger;">
                &copy; Marion Candusso | Tout droit réservé
            </div>
        </div>
    </footer>
</body>
</html>